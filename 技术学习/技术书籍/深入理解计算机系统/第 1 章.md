# 计算机系统漫游

---

计算机系统是由硬件和系统软件组成的，它们共同工作来运行应用程序。虽然系统的具体实现方式随着时间不断变化，但是内在的概念却没有改变。所有计算机系统都有着相似的硬件和软件，而它们又执行着相似的功能。

我们将跟踪 `hello` 程序的生命周期来开始对系统的学习——从它被程序员创建开始，到在系统上运行，输出简单的信息，最后中止。

```c file:hello.c
#include <stdio.h>

int main() {
  printf("Hello world!\n");
  return 0;
}
```

---

## 信息就是位 + 上下文

`hello` 程序的生命周期是从源文件开始的，本质上是比特序列，像 `hello.c` 这样只由字符构成的文件称为文本文件，所有其他文件都称为二进制文件。

`hello.c` 的表示方法说明了一个基本思想：系统中所有的信息，包括磁盘文件、内存中的程序、内存中存放的用户数据以及网络上传送的数据，都是由一串比特表示的。区分不同数据对象的唯一方法是我们读到这些数据对象时的上下文。

---

## 程序被其他程序翻译成不同的格式

为了在系统上运行 `hello.c` 程序，每条 C 语句都必须被其他程序转化为一系列的低级机器语言指令。然后这些指令按照一种称为可执行目标程序（可执行目标文件）的格式打包，并以二进制文件的形式存放起来。

Linux 系统上，从源文件到目标文件的转化是由编译期驱动程序（例如 GCC 或者 Clang）完成的，这个翻译过程可以分为四个阶段，如图所示。执行这四个阶段的程序（预处理器，编译期，汇编器和链接器）一起构成了编译系统 (compilation system）。

![[技术学习/技术书籍/深入理解计算机系统/Img/Chap01/CompilationSystem.svg]]

- 预处理阶段。预处理器（`cpp`）根据以字符 `#` 开头的命令，修改原始的 C 程序。比如 `hello.c` 中第 1 行的 `#include <stdio.h>` 命令告诉预处理器读取系统头文件 `stdio.h` 的内容，并把它直接插入程序文本中。结果就得到了另一个 C 程序，通常是以 `.i` 作为文件扩展名。
- 编译阶段。编译器（`cc1`）将文本文件 `hello.i` 翻译成文本文件 `hello.s`，它包含一个汇编语言程序。该程序包含函数 `main` 的定义，如下所示：

```nasm file:hello.s
main:
    subq $8, %rsp
    movl $.LC0, %edi
    call puts
    movl $0, %eax
    addq $8, %rsp
```

- 汇编阶段。接下来，汇编器（`as`）将 `hello.s` 翻译成机器语言指令，把这些指令打包成一种叫做可重定位目标程序（relocatable object program）的格式，并将结果保存在目标文件 `hello.o` 中。
- 链接阶段。`hello` 程序调用了 `printf` 函数，它是 C 编译器提供的标准 C 库中的一个函数。`printf` 函数存在于一个名为 `printf.o` 的单独的预编译好了的目标文件中，而这个文件必须以某种方式合并到我们的 `hello.o` 程序中。链接器（`ld`）就负责处理这种合并。结果就得到 `hello` 文件，它是一个可执行目标文件，可以被加载到内存中，由系统执行。

---

## 了解编译系统如何工作是大有益处的

- 优化程序性能。
- 理解链接时出现的错误。
- 避免安全漏洞。

---

## 处理器读并解释储存在内存中的指令

![[技术学习/技术书籍/深入理解计算机系统/Img/Chap01/HardwareOrganization.svg]]
